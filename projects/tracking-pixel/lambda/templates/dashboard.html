<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            color: #333;
            min-height: 100vh;
            padding: 2rem;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { font-size: 1.5rem; margin-bottom: 1.5rem; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; }
        .card {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .card h2 { font-size: 0.85rem; color: #666; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .big { font-size: 3rem; font-weight: 700; }
        .live { display: inline-flex; align-items: center; gap: 0.5rem; color: #22c55e; font-size: 0.75rem; margin-bottom: 1rem; }
        .live-dot { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #eee; }
        th { color: #999; font-weight: 500; }
        .bar { height: 6px; background: #111; border-radius: 3px; }
        .muted { color: #999; }
        a { color: #111; }
        .full { grid-column: 1 / -1; }
        .truncate { max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Dashboard</h1>
        <div class="live"><span class="live-dot"></span> Updates every 5s</div>

        <div class="grid">
            <div class="card">
                <h2>Today</h2>
                <div class="big" id="todayCount">-</div>
            </div>

            <div class="card">
                <h2>Browsers</h2>
                <table>
                    <thead><tr><th>Browser</th><th>Count</th><th></th></tr></thead>
                    <tbody id="browsers"><tr><td colspan="3" class="muted">Loading...</td></tr></tbody>
                </table>
            </div>

            <div class="card">
                <h2>Devices</h2>
                <table>
                    <thead><tr><th>Device</th><th>Count</th><th></th></tr></thead>
                    <tbody id="devices"><tr><td colspan="3" class="muted">Loading...</td></tr></tbody>
                </table>
            </div>

            <div class="card">
                <h2>Top Pages</h2>
                <table>
                    <thead><tr><th>Page</th><th>Count</th><th></th></tr></thead>
                    <tbody id="topPages"><tr><td colspan="3" class="muted">Loading...</td></tr></tbody>
                </table>
            </div>

            <div class="card full">
                <h2>Recent Events</h2>
                <table>
                    <thead><tr><th>Time</th><th>Method</th><th>Path</th><th>Browser</th><th>Device</th></tr></thead>
                    <tbody id="recentEvents"><tr><td colspan="5" class="muted">Loading...</td></tr></tbody>
                </table>
            </div>
        </div>

        <p style="margin-top: 2rem;"><a href="/demo">‚Üê Back to Demo</a></p>
    </div>

    <script>
        function renderTable(id, items, labelKey) {
            const el = document.getElementById(id);
            if (!items.length) {
                el.innerHTML = '<tr><td colspan="3" class="muted">No data</td></tr>';
                return;
            }
            const max = Math.max(...items.map(i => i.count || 0), 1);
            el.innerHTML = items.map(i =>
                '<tr><td class="truncate">' + (i[labelKey] || i.SK || '-') + '</td>' +
                '<td>' + (i.count || 0) + '</td>' +
                '<td style="width:60px"><div class="bar" style="width:' + ((i.count||0)/max*100) + '%"></div></td></tr>'
            ).join('');
        }

        async function poll() {
            try {
                const r = await fetch('/api/stats');
                const d = await r.json();

                document.getElementById('todayCount').textContent = d.dailyCount.toLocaleString();

                renderTable('browsers', d.browsers || [], 'SK');
                renderTable('devices', d.devices || [], 'SK');
                renderTable('topPages', d.topPages || [], 'SK');

                const events = document.getElementById('recentEvents');
                events.innerHTML = (d.recentEvents || []).length
                    ? d.recentEvents.map(e =>
                        '<tr><td>' + new Date(e.ts).toLocaleTimeString() + '</td>' +
                        '<td>' + (e.method || '-') + '</td>' +
                        '<td>' + (e.path || '-') + '</td>' +
                        '<td>' + (e.browser || '-') + '</td>' +
                        '<td>' + (e.device || '-') + '</td></tr>'
                    ).join('')
                    : '<tr><td colspan="5" class="muted">No events</td></tr>';
            } catch (e) {
                console.error(e);
            }
        }
        poll();
        setInterval(poll, 5000);
    </script>
</body>
</html>
